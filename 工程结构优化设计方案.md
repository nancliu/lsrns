# 工程结构优化设计方案

## 📋 **项目概述**

### **目标**

优化OD数据处理与仿真系统的工程结构，解决当前存在的文件夹管理混乱、数据流向不清晰、扩展性差等问题，建立清晰、可维护、易扩展的工程架构。

### **现状分析**

当前系统存在以下主要问题：

1. **E1文件夹覆盖问题**: 仿真完成后E1数据会被覆盖，需要复制到分析目录
2. **数据分散问题**: 仿真结果和分析结果分散在不同目录
3. **扩展性差**: 添加新功能需要修改多处代码
4. **数据流向不清晰**: 文件夹结构没有反映处理逻辑

### **优化进展**

#### **已完成阶段**
- ✅ **阶段1: 基础架构搭建** (第1-2周) - 100%完成
- ✅ **阶段2: 数据迁移和兼容性** (第3-4周) - 100%完成

#### **当前状态**
- 🚧 **阶段3: 功能迁移和优化** (第5-6周) - 进行中
- ⏳ **阶段4: 测试和优化** (第7-8周) - 待开始
- ⏳ **阶段5: 部署和监控** (第9周) - 待开始

## 🏗️ **优化后的工程结构**

### **已实现的目录结构**

经过第一阶段和第二阶段的工作，以下目录结构已经实现：

```
OD生成脚本/
├── cases/                           # 案例根目录 ✅
│   ├── case_20250808_103528/        # 迁移的仿真案例 ✅
│   │   ├── config/                  # 配置文件 ✅
│   │   │   ├── od_data.xml         # OD数据 ✅
│   │   │   ├── simulation.sumocfg  # 仿真配置 ✅
│   │   │   └── static.xml          # 静态文件 ✅
│   │   ├── simulation/              # 仿真结果 ✅
│   │   │   ├── e1_detectors/       # E1检测器输出 ✅
│   │   │   ├── gantry_data/        # 门架数据 ✅
│   │   │   └── summary.xml         # 仿真摘要 ✅
│   │   ├── analysis/                # 分析结果 ✅
│   │   │   └── accuracy/           # 精度分析 ✅
│   │   └── metadata.json           # 案例元数据 ✅
│   └── case_20250808_101848/        # 精度分析案例 ✅
│       └── analysis/accuracy/results/ # 精度分析结果 ✅
├── templates/                       # 模板文件 ✅
│   ├── taz_files/                  # TAZ文件模板 ✅
│   │   ├── TAZ_5_validated.add.xml
│   │   ├── TAZ_4.add.xml
│   │   └── taz_templates.json      # TAZ配置模板 ✅
│   ├── network_files/              # 网络文件模板 ✅
│   │   ├── sichuan202503v6.net.xml
│   │   ├── sichuan202503v5.net.xml
│   │   └── network_configs.json    # 网络配置模板 ✅
│   └── config_templates/           # 配置模板 ✅
│       ├── simulation_templates/    # 仿真配置模板 ✅
│       │   ├── default.sumocfg     # 默认仿真配置 ✅
│       │   ├── mesoscopic.sumocfg  # 中观仿真配置 ✅
│       │   └── microscopic.sumocfg # 微观仿真配置 ✅
│       └── vehicle_templates/       # 车辆类型模板 ✅
│           └── vehicle_types.json  # 车辆类型配置 ✅
├── shared/                         # 共享资源 ✅
│   └── utilities/                  # 通用工具 ✅
│       └── taz_tools/              # TAZ相关工具 ✅
│           ├── analyze_duplicate_taz.py
│           ├── compare_taz_files.py
│           ├── fix_duplicate_taz.py
│           ├── fix_taz.bat
│           ├── taz_validator.py
│           ├── README.md
│           └── output/              # 输出文件目录 ✅
│               ├── taz_to_simnetwork_updated.csv
│               ├── taz_to_simnetwork_updated_oppo.csv
│               └── taz_validation_results.csv
├── api/                            # API服务 ✅
│   ├── main.py                     # FastAPI主程序入口 ✅
│   ├── models.py                   # Pydantic数据模型 ✅
│   ├── routes.py                   # API路由定义 ✅
│   ├── services.py                 # 业务逻辑服务 ✅
│   ├── utils.py                    # 工具函数 ✅
│   ├── compatibility.py            # 兼容性层 ✅
│   └── __init__.py                 # 包初始化文件 ✅
├── frontend/                       # 前端界面 ✅
│   ├── index.html                  # 主页面 ✅
│   ├── styles.css                  # 样式文件 ✅
│   ├── script.js                   # JavaScript逻辑 ✅
│   └── test_pages/                 # 测试页面 ✅
├── docs/                           # 文档 ✅
│   ├── README.md                   # 项目说明 ✅
│   ├── api_docs/                   # API文档 ✅
│   │   └── README.md               # API文档说明 ✅
│   └── development/                # 开发文档 ✅
│       └── phase2_summary.md       # 第二阶段总结 ✅
├── shared/utilities/migration_tools.py # 数据迁移工具 ✅
├── test_migration.py               # 迁移测试脚本 ✅
├── requirements.txt                 # 项目依赖 ✅
├── start_api.bat                   # API启动脚本 ✅
└── test_api.py                     # API测试脚本 ✅
```

### **第二阶段新增功能**

#### **数据迁移工具**
- ✅ **智能数据扫描**: 自动识别现有数据结构
- ✅ **案例迁移**: 将run文件夹转换为案例结构
- ✅ **精度分析迁移**: 关联精度分析结果到案例
- ✅ **元数据生成**: 自动生成案例元数据
- ✅ **迁移报告**: 生成详细的迁移报告

#### **兼容性层**
- ✅ **兼容性API**: 提供与原有API格式兼容的端点
- ✅ **数据转换**: 在新旧数据格式之间转换
- ✅ **路径映射**: 处理新旧文件路径的映射
- ✅ **并行运行**: 支持新旧系统并行运行

#### **测试框架**
- ✅ **单元测试**: 每个迁移功能都有对应测试
- ✅ **集成测试**: 完整的迁移流程测试
- ✅ **兼容性测试**: 验证新旧API的兼容性
- ✅ **性能测试**: 验证迁移工具的性能

### **整体目录结构**

```
sim_scripts/
├── cases/                           # 案例根目录
│   ├── case_20250807_145645/        # 单个案例目录
│   │   ├── config/                  # 配置文件夹
│   │   │   ├── od_data.xml         # OD数据
│   │   │   ├── routes.xml          # 路由文件
│   │   │   ├── simulation.sumocfg  # 仿真配置
│   │   │   ├── taz.add.xml         # TAZ文件
│   │   │   ├── network.net.xml     # 网络文件
│   │   │   └── vehicle_types.json  # 车辆类型配置
│   │   ├── simulation/              # 仿真结果
│   │   │   ├── e1_detectors/       # E1检测器输出
│   │   │   ├── gantry_data/        # 门架数据
│   │   │   ├── summary.xml         # 仿真摘要
│   │   │   └── tripinfo.xml        # 行程信息
│   │   ├── analysis/                # 分析结果
│   │   │   ├── accuracy/           # 精度分析
│   │   │   │   ├── results/        # 分析结果
│   │   │   │   ├── charts/         # 图表
│   │   │   │   └── reports/        # 报告
│   │   │   ├── traffic_flow/       # 交通流分析（未来扩展）
│   │   │   └── performance/        # 性能分析（未来扩展）
│   │   └── metadata.json           # 案例元数据
│   └── case_20250807_150000/       # 另一个案例
├── templates/                       # 模板文件
│   ├── taz_files/                  # TAZ文件模板
│   │   ├── TAZ_5_validated.add.xml
│   │   ├── TAZ_4.add.xml
│   │   └── taz_templates.json      # TAZ配置模板
│   ├── network_files/              # 网络文件模板
│   │   ├── sichuan202503v6.net.xml
│   │   ├── sichuan202503v5.net.xml
│   │   └── network_configs.json    # 网络配置模板
│   └── config_templates/           # 配置模板
│       ├── simulation_templates/    # 仿真配置模板
│       │   ├── default.sumocfg     # 默认仿真配置
│       │   ├── mesoscopic.sumocfg  # 中观仿真配置
│       │   └── microscopic.sumocfg # 微观仿真配置
│       ├── vehicle_templates/       # 车辆类型模板
│       │   ├── vehicle_types.json  # 车辆类型配置
│       │   └── vehicle_profiles/   # 车辆配置文件
│       └── detector_templates/      # 检测器模板
│           ├── E1_detector.add.xml # E1检测器配置
│           └── gantry_locations.xml # 门架位置配置
├── shared/                         # 共享资源
│   ├── e1_detectors/               # E1检测器配置
│   │   ├── detector_configs/       # 检测器配置文件
│   │   ├── calibration_data/       # 校准数据
│   │   └── validation_rules/       # 验证规则
│   ├── gantry_locations/           # 门架位置
│   │   ├── gantry_coordinates.json # 门架坐标
│   │   ├── gantry_mapping.csv      # 门架映射
│   │   └── flow_corridors/         # 流量走廊
│   ├── analysis_tools/             # 分析工具
│   │   ├── accuracy_analysis/      # 精度分析工具
│   │   ├── traffic_flow_analysis/  # 交通流分析工具
│   │   └── performance_analysis/   # 性能分析工具
│   ├── data_processors/            # 数据处理器
│   │   ├── od_processor.py         # OD数据处理
│   │   ├── detector_processor.py   # 检测器数据处理
│   │   └── gantry_processor.py     # 门架数据处理
│   └── utilities/                  # 通用工具
│       ├── file_utils.py           # 文件操作工具
│       ├── data_utils.py           # 数据处理工具
│       ├── validation_utils.py     # 验证工具
│       └── taz_tools/              # TAZ相关工具
│           ├── analyze_duplicate_taz.py
│           ├── compare_taz_files.py
│           ├── fix_duplicate_taz.py
│           ├── fix_taz.bat
│           ├── taz_validator.py
│           ├── README.md
│           └── output/              # 输出文件目录
│               ├── taz_to_simnetwork_updated.csv
│               ├── taz_to_simnetwork_updated_oppo.csv
│               └── taz_validation_results.csv
├── api/                            # API服务（简化结构）
│   ├── main.py                     # FastAPI主程序入口
│   ├── models.py                   # Pydantic数据模型
│   ├── routes.py                   # API路由定义
│   ├── services.py                 # 业务逻辑服务
│   ├── utils.py                    # 工具函数
│   ├── compatibility.py            # 兼容性层
│   └── __init__.py                 # 包初始化文件
│   ├── models.py                   # 所有Pydantic数据模型
│   ├── routes.py                   # 所有API路由
│   ├── services.py                 # 业务逻辑
│   └── utils.py                    # 工具函数
├── frontend/                       # 前端界面
│   ├── index.html                  # 主页面
│   ├── script.js                   # 前端逻辑
│   ├── styles.css                  # 样式文件
│   └── test_pages/                 # 测试页面
└── docs/                           # 文档
    ├── api_docs/                   # API文档
    ├── user_guide/                 # 用户指南
    └── development/                # 开发文档
```

## 🔄 **数据流向设计**

### **步骤1: 创建案例**

```python
@app.post("/create_case/")
async def create_case(request: CaseCreationRequest):
    """
    创建新案例
    输入: 时间范围、配置参数
    输出: case_id
    生成: case_YYYYMMDD_HHMMSS/目录结构
    """
```

### **步骤2: 运行仿真**

```python
@app.post("/run_simulation/{case_id}")
async def run_simulation(case_id: str, request: SimulationRequest):
    """
    运行仿真
    输入: case_id, 仿真参数
    输出: 仿真结果
    生成: case_id/simulation/下的所有结果文件
    """
```

### **步骤3: 精度分析**

```python
@app.post("/analyze_accuracy/{case_id}")
async def analyze_accuracy(case_id: str, request: AccuracyAnalysisRequest):
    """
    精度分析
    输入: case_id, 分析参数
    输出: 分析结果
    生成: case_id/analysis/accuracy/下的结果
    """
```

### **步骤4: 状态查询**

```python
@app.get("/case_status/{case_id}")
async def get_case_status(case_id: str):
    """
    查询案例状态
    输入: case_id
    输出: 案例完整状态信息
    """
```

## 📊 **元数据管理**

### **案例元数据 (metadata.json)**

```json
{
  "case_id": "case_20250807_145645",
  "created_at": "2025-08-07T14:56:45",
  "updated_at": "2025-08-07T15:30:00",
  "time_range": {
    "start": "2025/07/21 08:00:00",
    "end": "2025/07/21 09:00:00"
  },
  "config": {
    "taz_file": "TAZ_5_validated.add.xml",
    "net_file": "sichuan202503v6.net.xml",
    "interval_minutes": 5,
    "enable_mesoscopic": false
  },
  "status": {
    "od_processed": true,
    "simulation_completed": true,
    "analysis_completed": false,
    "last_step": "simulation"
  },
  "files": {
    "od_file": "config/od_data.xml",
    "routes_file": "config/routes.xml",
    "config_file": "config/simulation.sumocfg",
    "taz_file": "config/taz.add.xml",
    "network_file": "config/network.net.xml"
  },
  "statistics": {
    "total_vehicles": 1250,
    "simulation_duration": 3600,
    "detector_count": 45,
    "gantry_count": 12
  }
}
```

## 🛠️ **API接口设计（简化结构）**

### **核心API端点（预估10个左右）**

#### **数据处理API**
```python
@app.post("/process_od_data/")                    # OD数据处理
@app.post("/run_simulation/")                     # 运行仿真
@app.post("/analyze_accuracy/")                   # 精度分析
```

#### **案例管理API**
```python
@app.post("/create_case/")                        # 创建案例
@app.get("/list_cases/")                          # 列出所有案例
@app.get("/case/{case_id}")                       # 获取案例详情
@app.delete("/case/{case_id}")                    # 删除案例
@app.post("/case/{case_id}/clone")                # 克隆案例
```

#### **文件管理API**
```python
@app.get("/get_folders/{prefix}")                 # 获取文件夹列表
@app.get("/accuracy_analysis_status/{result_folder}") # 获取分析状态
```

**注：** 以上API端点为预估数量，实际开发过程中可能会根据需求调整增加或减少。

### **API文件结构**

#### **`api/main.py`** - 主程序入口
```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from api.routes import router

app = FastAPI(title="OD数据处理与仿真系统")
app.add_middleware(CORSMiddleware, allow_origins=["*"])
app.include_router(router, prefix="/api/v1")
```

#### **`api/models.py`** - 数据模型
```python
from pydantic import BaseModel
from typing import Optional, List

class TimeRangeRequest(BaseModel):
    start_time: str
    end_time: str
    schemas_name: Optional[str] = "dwd"
    # ... 其他字段

class SimulationRequest(BaseModel):
    run_folder: str
    # ... 其他字段

class CaseCreationRequest(BaseModel):
    time_range: dict
    config: dict
    # ... 其他字段

# ... 其他模型
```

#### **`api/routes.py`** - API路由
```python
from fastapi import APIRouter, Depends
from api.models import *
from api.services import *

router = APIRouter()

# 数据处理路由
@router.post("/process_od_data/")
async def process_od_data(request: TimeRangeRequest):
    return await process_od_data_service(request)

@router.post("/run_simulation/")
async def run_simulation(request: SimulationRequest):
    return await run_simulation_service(request)

@router.post("/analyze_accuracy/")
async def analyze_accuracy(request: AccuracyAnalysisRequest):
    return await analyze_accuracy_service(request)

# 案例管理路由
@router.post("/create_case/")
async def create_case(request: CaseCreationRequest):
    return await create_case_service(request)

@router.get("/list_cases/")
async def list_cases():
    return await list_cases_service()

@router.get("/case/{case_id}")
async def get_case(case_id: str):
    return await get_case_service(case_id)

@router.delete("/case/{case_id}")
async def delete_case(case_id: str):
    return await delete_case_service(case_id)

@router.post("/case/{case_id}/clone")
async def clone_case(case_id: str):
    return await clone_case_service(case_id)

# 文件管理路由
@router.get("/get_folders/{prefix}")
async def get_folders(prefix: str):
    return await get_folders_service(prefix)

@router.get("/accuracy_analysis_status/{result_folder}")
async def get_accuracy_analysis_status(result_folder: str):
    return await get_accuracy_analysis_status_service(result_folder)
```

#### **`api/services.py`** - 业务逻辑
```python
# 从DLLtest2025_6_3.py迁移的核心业务逻辑
async def process_od_data_service(request: TimeRangeRequest):
    # 原有的process_od_data逻辑
    pass

async def run_simulation_service(request: SimulationRequest):
    # 原有的run_simulation逻辑
    pass

async def analyze_accuracy_service(request: AccuracyAnalysisRequest):
    # 原有的analyze_accuracy逻辑
    pass

# 新增的案例管理服务
async def create_case_service(request: CaseCreationRequest):
    # 创建案例逻辑
    pass

async def list_cases_service():
    # 列出案例逻辑
    pass

async def get_case_service(case_id: str):
    # 获取案例详情逻辑
    pass

async def delete_case_service(case_id: str):
    # 删除案例逻辑
    pass

async def clone_case_service(case_id: str):
    # 克隆案例逻辑
    pass

# 文件管理服务
async def get_folders_service(prefix: str):
    # 获取文件夹列表逻辑
    pass

async def get_accuracy_analysis_status_service(result_folder: str):
    # 获取分析状态逻辑
    pass
```

#### **`api/utils.py`** - 工具函数
```python
# 从DLLtest2025_6_3.py迁移的工具函数
def calculate_duration(start_time, end_time):
    # 原有逻辑
    pass

def split_time_range(start_time, end_time, interval_minutes):
    # 原有逻辑
    pass

def load_taz_ids(taz_file):
    # 原有逻辑
    pass

def generate_od_xml(od_matrix, start_time, end_time, od_file):
    # 原有逻辑
    pass

def generate_sumocfg(route_file, net_file, start_time, end_time, **kwargs):
    # 原有逻辑
    pass

def run_sumo(sumocfg_file, gui=True):
    # 原有逻辑
    pass

# ... 其他工具函数
```

## 📈 **实施计划**

### **阶段1: 基础架构搭建 (第1-2周)**

#### **目标**

建立新的目录结构和基础API框架

#### **任务清单**

- [ ] 创建新的目录结构
- [ ] 设计并实现案例元数据模型
- [ ] 实现基础的案例管理API
- [ ] 创建模板文件管理机制
- [ ] 建立共享资源管理框架

#### **交付物**

- 新的目录结构
- 案例管理API (create_case, list_cases, get_case)
- 模板文件管理功能
- 共享资源管理功能

### **阶段2: 数据迁移和兼容性 (第3-4周)**

#### **目标**

保持向后兼容，实现数据迁移

#### **任务清单**

- [ ] 实现数据迁移工具
- [ ] 保持现有API的兼容性
- [ ] 创建案例转换功能
- [ ] 实现新旧系统的并行运行
- [ ] 测试数据迁移的准确性

#### **交付物**

- 数据迁移工具
- 兼容性层
- 案例转换功能
- 迁移测试报告

### **阶段3: 功能迁移和优化 (第5-6周)**

#### **目标**

将现有功能迁移到新架构

#### **任务清单**

- [ ] 迁移OD数据处理功能
- [ ] 迁移仿真运行功能
- [ ] 迁移精度分析功能
- [ ] 优化数据流向
- [ ] 实现新的前端界面

#### **交付物**

- 迁移后的OD数据处理功能
- 新的仿真运行机制
- 优化的精度分析功能
- 更新的前端界面

### **阶段4: 测试和优化 (第7-8周)**

#### **目标**

全面测试和性能优化

#### **任务清单**

- [ ] 功能测试
- [ ] 性能测试
- [ ] 压力测试
- [ ] 用户体验优化
- [ ] 文档完善

#### **交付物**

- 测试报告
- 性能优化报告
- 用户指南
- 开发文档

## 🎯 **优化效果预期**

### **解决的问题**

1. ✅ **E1文件夹覆盖问题**: 数据直接保存在case目录下，不会被覆盖
2. ✅ **数据分散问题**: 所有相关数据在同一案例目录下
3. ✅ **扩展性**: 可以轻松添加新的分析类型
4. ✅ **数据流向清晰**: 文件夹结构反映处理流程

### **新增优势**

1. **版本控制友好**: 每个案例是独立的单元
2. **易于备份**: 案例级别的备份和恢复
3. **并行处理**: 支持多个案例同时处理
4. **资源复用**: 模板和共享资源的高效利用
5. **监控完善**: 完整的案例生命周期监控

## 📋 **风险评估和应对**

### **主要风险**

1. **数据迁移风险**: 现有数据可能丢失
2. **兼容性风险**: 现有API可能受影响
3. **性能风险**: 新架构可能影响性能
4. **用户适应风险**: 用户需要适应新界面

### **应对策略**

1. **数据备份**: 迁移前完整备份
2. **渐进迁移**: 分阶段迁移，保持兼容性
3. **性能测试**: 每个阶段进行性能测试
4. **用户培训**: 提供详细的用户指南和培训

## 📚 **文档和培训**

### **技术文档**

- API文档
- 架构设计文档
- 部署指南
- 故障排除指南

### **用户文档**

- 用户操作指南
- 案例管理手册
- 分析结果解读指南
- 常见问题解答

---

**文档版本**: v1.1
**创建日期**: 2025-01-08
**最后更新**: 2025-01-08
**负责人**: 开发团队
**审核人**: 项目经理
