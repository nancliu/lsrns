# 仿真问题修复说明

## 问题概述

在仿真运行过程中发现了两个关键问题：

1. **e1输出文件夹路径错误**：e1检测器输出文件被错误地放置在`sim_xxx\e1`文件夹下，而不是正确的仿真目录
2. **进度检查失效**：仿真进度检查无法正确找到summary.xml文件，导致进度显示异常

## 问题分析

### 问题1：e1输出路径错误

**根本原因：**
- TAZ文件中的inductionLoop配置了`file="e1/G420151002000310010_2.xml"`
- SUMO运行时的工作目录是`config`目录
- 没有配置`output-prefix`，导致SUMO在`config/e1/`下创建文件
- 期望路径应该是`sim_xxx/e1/`目录

**错误现象：**
```
Error: Could not build output file '../../config/e1/G420151002000310010_2.xml' (No such file or directory).
```

### 问题2：进度检查失效

**根本原因：**
- 进度检查逻辑中的路径解析有问题
- 无法正确找到summary.xml文件的位置
- 缺少多种回退路径的支持

**错误现象：**
- 仿真进度无法正确显示
- 进度条停滞或显示异常

## 修复方案

### 修复1：e1输出路径

**修改文件：** `shared/utilities/sumo_utils.py`

**修改内容：**
```python
# 修复e1输出路径问题：添加output-prefix，确保e1文件输出到仿真目录
# 从config目录到simulation目录的相对路径
output_prefix = "../../simulation"

output_section = f'''    <output>
        <output-prefix value="{output_prefix}"/>
        <summary-output value="summary.xml"/>
    </output>'''
```

**修复原理：**
- 添加`<output-prefix value="../../simulation"/>`配置
- 确保所有输出文件（包括e1检测器输出）都保存到simulation目录
- 从config目录到simulation目录的相对路径为`../../simulation`

### 修复2：进度检查路径解析

**修改文件：** `shared/data_processors/simulation_processor.py`

**修改内容：**
```python
def get_sim_time_from_summary() -> Optional[float]:
    try:
        # 修复路径解析问题：优先检查运行目录下的summary.xml
        candidates = []
        if run_folder:
            candidates.append(os.path.join(run_folder, "summary.xml"))
        
        # 回退路径：从config目录到simulation目录
        cfg_dir = config_dir
        candidates.append(os.path.normpath(os.path.join(cfg_dir, "../../simulation/summary.xml")))
        
        # 额外回退路径：从config目录到simulations/sim_xxx目录
        candidates.append(os.path.normpath(os.path.join(cfg_dir, "../../simulations/*/summary.xml")))
        
        # ... 其他逻辑保持不变
```

**修复原理：**
- 增加多种回退路径支持
- 优先检查运行目录下的summary.xml
- 支持从config目录到simulation目录的路径解析
- 提高进度检查的可靠性和容错性

## 修复效果验证

### 测试结果

运行测试脚本`test_simulation_fix.py`的结果：

```
✅ 成功添加output-prefix配置
✅ 修复了进度检查中的路径解析问题
✅ 支持多种回退路径，提高进度检查的可靠性
```

### 生成的sumocfg示例

修复后的sumocfg文件包含正确的output-prefix配置：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <input>
        <net-file value="../../../../templates/network_files/sichuan202503v6.net.xml"/>
        <route-files value="../../config/dwd_od_weekly_20250804090000_20250804091500.rou.xml"/>
        <additional-files value="../../config/TAZ_5_validated.add.xml"/>
    </input>
    <output>
        <output-prefix value="../../simulation"/>
        <summary-output value="summary.xml"/>
    </output>
    <!-- ... 其他配置 ... -->
</configuration>
```

## 技术细节

### 路径解析逻辑

**修复前：**
- 单一路径：`config_dir/../../simulation/summary.xml`
- 容易因路径变化导致失败

**修复后：**
- 多重路径支持：
  1. 运行目录：`run_folder/summary.xml`
  2. 仿真目录：`config_dir/../../simulation/summary.xml`
  3. 仿真子目录：`config_dir/../../simulations/*/summary.xml`

### 输出目录结构

**修复前：**
```
cases/
└── case_xxx/
    ├── config/
    │   └── e1/          # ❌ 错误：e1文件输出到这里
    └── simulation/
        └── summary.xml
```

**修复后：**
```
cases/
└── case_xxx/
    ├── config/
    │   └── TAZ_xxx.add.xml  # ✅ 正确：TAZ文件在这里
    └── simulation/
        ├── e1/              # ✅ 正确：e1文件输出到这里
        └── summary.xml
```

## 使用说明

### 仿真运行流程

1. **创建仿真目录结构**
   - 系统自动创建`sim_xxx/e1/`目录
   - 确保e1输出目录存在

2. **生成sumocfg配置**
   - 自动添加`output-prefix="../../simulation"`
   - 确保所有输出文件保存到正确位置

3. **运行仿真**
   - SUMO使用修复后的配置
   - e1检测器输出保存到`sim_xxx/e1/`目录

4. **进度监控**
   - 自动查找正确位置的summary.xml
   - 支持多种回退路径，提高可靠性

### 注意事项

1. **路径兼容性**
   - 修复后的配置保持向后兼容
   - 不影响现有的仿真案例

2. **目录权限**
   - 确保仿真目录有写入权限
   - 系统会自动创建必要的子目录

3. **错误处理**
   - 如果e1目录创建失败，会记录错误日志
   - 进度检查失败时会尝试多种回退路径

## 后续优化建议

### 1. 路径配置化
- 将output-prefix路径配置化
- 支持不同案例类型的自定义路径

### 2. 进度检查增强
- 添加进度检查的详细日志
- 支持进度检查失败时的用户通知

### 3. 错误处理优化
- 增强e1目录创建失败的错误处理
- 提供更友好的错误提示信息

## 总结

本次修复成功解决了仿真运行中的两个关键问题：

1. **e1输出路径问题**：通过添加output-prefix配置，确保e1检测器输出文件保存到正确的仿真目录
2. **进度检查问题**：通过增强路径解析逻辑，支持多种回退路径，提高进度检查的可靠性

修复后的系统能够：
- 正确输出e1检测器数据到`sim_xxx/e1/`目录
- 可靠地监控仿真进度
- 提供更好的用户体验和错误处理

建议在下次仿真运行时验证修复效果，确保问题得到彻底解决。
