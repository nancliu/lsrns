# SUMO 参数标定策略详细设计

## 1. 问题分析

### 1.1 当前仿真问题
- **仿真精度不高**: 生成的车辆行为与真实交通环境差异较大
- **车辆容量不足**: 仿真路网无法容纳接近真实路网的车辆数量
- **参数未优化**: SUMO默认参数未针对具体路网和交通特征进行调优

### 1.2 标定目标
- 提高仿真车辆与真实交通环境的拟真度
- 确保仿真路网能容纳接近真实路网的车辆数量
- 通过参数优化提升整体仿真精度

## 2. 参数选择与影响分析

### 2.1 核心参数集合（7个关键参数）

| 参数 | 类型 | 取值范围 | 默认值 | 影响机制 | 优先级 |
|------|------|----------|--------|----------|--------|
| `departSpeed` | categorical/float | {"max", "random", 2.0-5.0} | "max" | 影响车辆插入成功率和初始速度分布 | 高 |
| `departLane` | categorical | {"free", "random"} | "free" | 影响车辆在路网中的分布和拥堵模式 | 高 |
| `minGap` | float | [0.5, 3.0] | 2.5 | 影响车辆间距和路网容量 | 中 |
| `sigma` | float | [0.0, 0.5] | 0.5 | 影响驾驶行为的随机性和真实性 | 中 |
| `impatience` | float | [0.5, 1.0] | 0.5 | 影响车辆变道和超车行为 | 中 |
| `maxDepartDelay` | int | [30, 600] | 300 | 影响车辆插入等待时间和路网利用率 | 低 |
| `laneChangeMode` | categorical/int | {0, 1621, 512} | 1621 | 影响车辆变道策略和交通流稳定性 | 中 |

### 2.2 参数编码策略

#### 2.2.1 连续参数编码
```python
# 连续参数归一化到[0,1]区间
normalized_value = (value - min_value) / (max_value - min_value)
```

#### 2.2.2 分类参数编码
```python
# 分类参数转换为整数索引
categorical_mapping = {
    "departSpeed": {"max": 0, "random": 1, "2.0": 2, "3.0": 3, "4.0": 4, "5.0": 5},
    "departLane": {"free": 0, "random": 1},
    "laneChangeMode": {0: 0, 1621: 1, 512: 2}
}
```

## 3. 标定策略设计

### 3.1 混合优化架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   遗传算法GA    │    │   XGBoost代理   │    │   SUMO仿真      │
│                 │    │   模型          │    │                 │
│ - 种群初始化    │◄──►│ - 参数预测      │◄──►│ - 真实仿真      │
│ - 选择/交叉/变异│    │ - 增量学习      │    │ - 指标收集      │
│ - 适应度评估    │    │ - 模型更新      │    │ - 结果验证      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 3.2 优化流程

#### 阶段1: 初始数据收集
1. **拉丁超立方采样(LHS)**: 生成50-100组参数组合
2. **并行仿真**: 每组参数运行完整SUMO仿真
3. **指标收集**: 记录流量、延误、插入成功率等关键指标
4. **数据预处理**: 清洗和标准化数据

#### 阶段2: 代理模型训练
1. **特征工程**: 参数编码和特征转换
2. **模型训练**: 使用XGBoost拟合参数-性能关系
3. **模型验证**: 交叉验证确保模型泛化能力
4. **超参数调优**: 优化XGBoost模型参数

#### 阶段3: 混合优化迭代
1. **GA优化**: 使用代理模型预测大部分个体的适应度
2. **真实仿真**: 每代随机选择2-3个个体进行真实仿真
3. **模型更新**: 基于真实仿真结果增量更新代理模型
4. **收敛判断**: 连续多代无改善或达到最大迭代次数

#### 阶段4: 最终验证
1. **候选解筛选**: 选择top-10个体
2. **真实仿真验证**: 对所有候选解进行完整仿真
3. **参数选择**: 基于验证结果选择最优参数组合
4. **性能分析**: 生成详细的标定效果报告

## 4. 评估指标体系

### 4.1 主要评估指标

#### 4.1.1 流量匹配度
```python
flow_error = abs(simulated_flow - observed_flow) / observed_flow
```

#### 4.1.2 延误准确性
```python
delay_error = abs(simulated_delay - observed_delay) / observed_delay
```

#### 4.1.3 插入成功率
```python
insertion_rate = successful_insertions / total_planned_vehicles
```

#### 4.1.4 路网利用率
```python
network_utilization = actual_vehicles / max_capacity
```

### 4.2 综合适应度函数

```python
def calculate_fitness(flow_error, delay_error, insertion_rate, network_utilization):
    # 权重配置
    w1, w2, w3, w4 = 0.3, 0.3, 0.25, 0.15
    
    # 归一化处理
    normalized_flow_error = min(flow_error, 1.0)  # 限制最大误差
    normalized_delay_error = min(delay_error, 1.0)
    
    # 计算综合得分 (得分越高越好)
    fitness = (w1 * (1 - normalized_flow_error) + 
               w2 * (1 - normalized_delay_error) + 
               w3 * insertion_rate + 
               w4 * network_utilization)
    
    return fitness
```

## 5. 技术实现要点

### 5.1 并行仿真策略
- **多进程并行**: 使用`multiprocessing.Pool`管理多个SUMO实例
- **资源管理**: 控制并发数量避免系统资源过载
- **结果同步**: 异步收集仿真结果并更新优化状态

### 5.2 代理模型管理
- **增量学习**: 定期使用新数据更新XGBoost模型
- **模型版本控制**: 保存不同阶段的模型版本用于回滚
- **预测置信度**: 评估预测结果的可信度，指导真实仿真选择

### 5.3 收敛策略
- **早停机制**: 连续多代无改善时提前终止
- **多样性保持**: 使用拥挤度距离等策略维持种群多样性
- **局部搜索**: 在最优解附近进行精细搜索

## 6. 预期效果与风险控制

### 6.1 预期改进效果
- **仿真精度提升**: 流量误差降低30-50%
- **车辆容量增加**: 路网利用率提升20-40%
- **计算效率提升**: 通过代理模型加速，总体计算时间减少60-80%

### 6.2 风险控制措施
- **参数边界控制**: 严格限制参数取值范围，避免不合理配置
- **仿真稳定性**: 监控仿真崩溃率，及时调整问题参数
- **结果验证**: 多轮验证确保标定结果的稳定性和可靠性

## 7. 实施计划

### 7.1 阶段划分
- **第1周**: 环境搭建和基础代码开发
- **第2-3周**: 初始数据收集和代理模型训练
- **第4-5周**: 混合优化迭代和参数收敛
- **第6周**: 最终验证和结果分析

### 7.2 关键里程碑
- [ ] 完成参数范围定义和编码策略
- [ ] 建立初始数据集（50-100组参数组合）
- [ ] 训练并验证XGBoost代理模型
- [ ] 完成50-100代GA优化迭代
- [ ] 获得最优参数组合并验证效果
- [ ] 生成完整的标定报告

### 7.3 成功标准
- 仿真流量误差 < 15%
- 仿真延误误差 < 20%
- 车辆插入成功率 > 95%
- 路网利用率 > 80%
- 总体计算时间相比全真实仿真减少 > 60%
