# 门架数据管理说明

## 概述

本文档说明了系统中门架数据的组织结构和命名规范。门架数据是精度分析的重要输入，系统采用文件夹结构来组织和管理这些数据。重构完成后，门架数据管理功能已完全集成到新的模块化架构中。

## 文件夹结构

### 1. 门架数据文件夹命名规则

门架数据文件夹采用以下命名格式：
```
gantry_YYYYMMDD_HHMMSS_YYYYMMDD_HHMMSS
```

其中：
- `gantry_` 是固定前缀
- 前半部分为开始时间，后半部分为结束时间（均为 YYYYMMDD_HHMMSS 格式）
- 文件夹命名的起止时间与数据库查询语句使用的起止时间参数保持一致

#### 命名示例

| 时间范围 | 文件夹名称 | 说明 |
|---------|-----------|------|
| 2025/08/19 08:00:00 - 2025/08/19 18:00:00 | `gantry_20250819_080000_20250819_180000` | 单日数据 |
| 2025/08/19 08:00:00 - 2025/08/20 18:00:00 | `gantry_20250819_080000_20250820_180000` | 跨日数据 |
| 2025-08-19 08:00:00 - 2025-08-19 09:30:00 | `gantry_20250819_080000_20250819_093000` | 支持横杠分隔格式 |

### 2. 文件夹内容

每个门架数据文件夹包含以下文件：

```
gantry_20250819_080000_20250819_180000/
├── gantry_data_raw.csv      # 门架数据（CSV格式）
└── gantry_summary.json      # 门架数据摘要信息
```

#### 文件说明

- `gantry_data_raw.csv`: 从数据库查询得到的门架数据，包含所有门架观测记录
- `gantry_summary.json`: 门架数据的元数据摘要，包含：
  - 总记录数
  - 唯一门架ID数量
  - 时间范围
  - 数据列信息
  - 创建时间

### 3. 目录结构示例

```
cases/
└── case_20250819_100814/
    ├── metadata.json                                        # 案例元数据（含 time_range.start/end）
    ├── gantry_20250819_080000_20250819_180000/              # 门架数据文件夹
    │   ├── gantry_data_raw.csv
    │   └── gantry_summary.json
    ├── simulations/                                         # 仿真结果
    └── analysis/                                            # 分析结果
```

## 数据获取流程

### 1. 自动获取流程

当进行精度分析时，系统会：

1. **检查现有数据**: 查找案例目录下是否已有 `gantry_*` 门架数据文件夹
2. **创建文件夹**: 如果没有，根据案例 `metadata.json` 中的 `time_range.start/end` 创建新门架文件夹（命名与查询参数一致）
3. **获取数据**: 从数据库查询对应时间范围的门架数据
4. **保存数据**: 将数据保存到门架文件夹中

### 2. 数据库表结构

门架数据来源于 `dwd.dwd_flow_gantry_weekly` 表，该表采用周分区策略，包含以下关键字段：

#### 核心字段
- `start_gantryid`: 起始门架编码（主键组成部分）
- `end_gantryid`: 结束门架编码
- `start_time`: 统计时间（分区键，主键组成部分）
- `total`: 总流量
- `avg_speed`: 平均速度

#### 车型分类流量
- **客车流量**: `k1`, `k2`, `k3`, `k4` (客车1-4类)
- **货车流量**: `h1`, `h2`, `h3`, `h4`, `h5`, `h6` (货车1-6类)
- **特种车流量**: `t1`, `t2`, `t3`, `t4`, `t5`, `t6` (特种车1-6类)
- **分类汇总**: `total_k` (客车总流量), `total_h` (货车总流量), `total_t` (特种车总流量)

#### 性能指标
- `avg_duration`: 平均耗时
- `distance`: 门架间距离
- `gantry_name`: 门架名称

#### 系统字段
- `id`: 自增ID
- `batch_id`: 批次ID
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 3. 手动提供数据

用户也可以手动创建门架数据文件夹，只需：

1. 在案例目录下创建 `gantry_YYYYMMDD_HHMMSS_YYYYMMDD_HHMMSS` 格式的文件夹
2. 在文件夹中放置 `gantry_data_raw.csv` 文件
3. 可选：创建 `gantry_summary.json` 摘要文件

**注意**: 手动提供的CSV文件应包含与数据库表结构兼容的列名，建议包含以下必要列：
- `gantry_id` 或 `start_gantryid`: 门架ID
- `start_time` 或 `time`: 时间戳
- `flow` 或 `total`: 流量
- `speed` 或 `avg_speed`: 速度
- `occupancy`: 占有率（可选）

## 技术实现

### 1. 核心方法

门架数据文件夹的创建和管理由 `api/services/base_service.py` 中的 `DirectoryManager` 类负责：

```python
class DirectoryManager:
    @staticmethod
    def get_or_create_gantry_folder(case_root: Path, start_time: str, end_time: str) -> Path:
        """获取或创建门架数据文件夹（命名：gantry_开始时间_结束时间）"""
        # 1. 查找现有文件夹
        existing_folder = DirectoryManager._find_existing_gantry_folder(case_root, start_time, end_time)
        if existing_folder:
            return existing_folder
        
        # 2. 创建新文件夹
        folder_name = DirectoryManager._generate_gantry_folder_name(start_time, end_time)
        gantry_folder = case_root / folder_name
        gantry_folder.mkdir(parents=True, exist_ok=True)
        
        return gantry_folder
```

### 2. 时间解析

系统使用 `shared/utilities/time_utils.py` 中的统一时间解析函数：

#### 主要解析方式
- **统一使用**: `shared.utilities.time_utils.parse_datetime` 函数
- **支持格式**: 
  - `YYYY/MM/DD HH:MM:SS`
  - `YYYY-MM-DD HH:MM:SS`
  - `YYYY-MM-DDT HH:MM:SS`
  - ISO8601格式

#### 时间解析示例
```python
from shared.utilities.time_utils import parse_datetime

# 解析时间字符串
start_dt = parse_datetime("2025/08/19 08:00:00")
end_dt = parse_datetime("2025/08/19 18:00:00")

# 生成文件夹名称
start_str = start_dt.strftime("%Y%m%d_%H%M%S")
end_str = end_dt.strftime("%Y%m%d_%H%M%S")
folder_name = f"gantry_{start_str}_{end_str}"
# 结果: gantry_20250819_080000_20250819_180000
```

### 3. 数据加载

门架数据的加载由 `shared/data_access/gantry_loader.py` 中的 `GantryDataLoader` 类负责：

```python
class GantryDataLoader:
    def load_gantry_data(self, start_time: datetime, end_time: datetime) -> pd.DataFrame:
        """从数据库加载指定时间范围的门架数据
        
        返回的DataFrame包含以下列：
        - gantry_id: 门架ID (来自 start_gantryid)
        - end_gantryid: 结束门架ID
        - gantry_name: 门架名称
        - start_time: 开始时间
        - end_time: 结束时间 (计算得出)
        - flow: 流量 (来自 total)
        - k1, k2, k3, k4: 客车流量
        - h1, h2, h3, h4, h5, h6: 货车流量
        - t1, t2, t3, t4, t5, t6: 特种车流量
        - total_k, total_h, total_t: 分类总流量
        - speed: 速度 (来自 avg_speed)
        - avg_duration: 平均耗时
        - distance: 距离
        - occupancy: 占有率 (计算得出)
        """
        # 实现数据库查询逻辑，基于 dwd.dwd_flow_gantry_weekly 表
        pass
    
    def check_data_availability(self, start_time: datetime, end_time: datetime) -> Dict[str, Any]:
        """检查指定时间范围内的门架数据可用性
        
        返回包含以下信息的字典：
        - available: 数据是否可用
        - total_records: 总记录数
        - unique_gantries: 唯一门架数量
        - total_flow: 总流量
        - avg_speed: 平均速度
        - time_range: 时间范围
        - daily_coverage: 每日数据覆盖情况
        - catalog_details: 数据目录详情
        """
        pass
```

## 精度分析集成

### 1. 分析流程

在精度分析过程中，系统会：

1. **检查门架数据**: 在 `api/services/analysis_service.py` 中检查是否存在门架数据
2. **自动获取**: 如果不存在，自动调用门架数据获取功能
3. **数据对齐**: 使用 `shared/analysis_tools/accuracy_analyzer.py` 进行数据对齐和精度计算

### 2. 数据对齐

精度分析器会自动处理列名对齐问题：

```python
# shared/analysis_tools/accuracy_analyzer.py
def calculate_accuracy_metrics(self, simulated_data: pd.DataFrame, observed_data: pd.DataFrame):
    # 列名统一为小写，便于对齐
    simulated_df.columns = [str(c).strip().lower() for c in simulated_df.columns]
    observed_df.columns = [str(c).strip().lower() for c in observed_df.columns]
    
    # 基于 dwd_flow_gantry_weekly 表结构的列名映射
    column_aliases = {
        "flow": ["flow", "total", "volume", "count", "veh_count"],
        "speed": ["speed", "avg_speed", "speed_kmh"],
        "occupancy": ["occupancy", "occ"],
        "gantry_id": ["gantry_id", "start_gantryid", "detector_id"],
        "time": ["start_time", "time", "timestamp", "begin"]
    }
    
    # 自动映射列名
    # ... 映射逻辑
```

## 重构改进

### 1. 代码复用

重构后的门架数据管理功能具有更好的代码复用性：

- **时间解析**: 统一使用 `shared.utilities.time_utils.parse_datetime`
- **数据库访问**: 统一使用 `shared.data_access.connection.open_db_connection`
- **文件操作**: 统一使用 `shared.utilities.file_utils` 中的工具函数

### 2. 命名简化

- **文件夹命名**: 直接使用 `gantry_开始时间_结束时间` 格式，无需额外前缀
- **文件命名**: 统一使用 `gantry_data.csv` 和 `gantry_data_summary.json`
- **方法命名**: 使用更直观的方法名，如 `get_or_create_gantry_folder`

### 3. 错误处理

- **统一异常处理**: 所有门架数据相关操作都使用统一的异常处理机制
- **优雅降级**: 如果门架数据获取失败，分析服务会提供相应的错误信息
- **日志记录**: 详细记录门架数据操作的每个步骤，便于调试

## 使用示例

### 1. 通过API自动获取

```python
# 调用精度分析API，系统会自动获取门架数据
POST /api/v1/analysis/analyze_accuracy/
{
    "case_id": "case_20250819_100814",
    "simulation_id": "sim_20250819_100814",
    "analysis_type": "comprehensive"
}
```

### 2. 手动创建门架数据

```bash
# 1. 创建门架数据文件夹
mkdir -p cases/case_20250819_100814/gantry_20250819_080000_20250819_180000

# 2. 放置门架数据文件
cp your_gantry_data.csv cases/case_20250819_100814/gantry_20250819_080000_20250819_180000/gantry_data_raw.csv

# 3. 可选：创建摘要文件
echo '{"total_records": 1000, "gantry_count": 5}' > cases/case_20250819_100814/gantry_20250819_080000_20250819_180000/gantry_summary.json
```

### 3. 编程方式使用

```python
from api.services.analysis_service import AnalysisService
from shared.data_access.gantry_loader import GantryDataLoader

# 创建分析服务
analysis_service = AnalysisService()

# 执行精度分析（会自动获取门架数据）
result = await analysis_service.analyze_accuracy(
    case_id="case_20250819_100814",
    simulation_id="sim_20250819_100814"
)

# 手动加载门架数据
from datetime import datetime
from shared.utilities.time_utils import parse_datetime

gantry_loader = GantryDataLoader()
start_dt = parse_datetime("2025/08/19 08:00:00")
end_dt = parse_datetime("2025/08/19 18:00:00")

# 检查数据可用性
availability = gantry_loader.check_data_availability(start_dt, end_dt)
if availability['available']:
    print(f"✅ 数据可用: {availability['total_records']}条记录")
    gantry_data = gantry_loader.load_gantry_data(start_dt, end_dt)
else:
    print(f"❌ 数据不可用: {availability.get('error', '未知错误')}")

gantry_loader.close()  # 记得关闭连接
```

## 注意事项

### 1. 时间格式

- 确保时间字符串格式与系统支持的标准格式一致
- 建议使用 `YYYY/MM/DD HH:MM:SS` 格式，兼容性最好
- 系统会自动处理时区问题（默认使用本地时区）

### 2. 数据时间范围

- **当前数据库数据覆盖范围**: 2025年6月9日 - 2025年7月6日（28天）
- **分区策略**: 按周分区，每周数据存储在独立分区中
- **数据更新频率**: 按批次每周导入上一周数据
- **建议查询范围**: 避免查询超出数据覆盖范围的时间段

### 2. 数据质量

- 门架数据应包含必要的列：门架ID（start_gantryid）、时间（start_time）、流量（total）、速度（avg_speed）、占有率（occupancy）等
- 数据时间范围应与案例的时间范围一致
- 建议在数据加载后进行基本的数据质量检查
- 数据来源于 `dwd.dwd_flow_gantry_weekly` 表，包含完整的车型分类流量（k1-k4客车、h1-h6货车、t1-t6特种车）

### 3. 性能考虑

- 门架数据文件可能较大，建议定期清理不需要的历史数据
- 对于大量数据的分析，系统会自动进行数据采样和缓存
- 数据库查询会使用适当的索引优化查询性能

## 故障排除

### 1. 常见问题

#### 门架数据文件夹未创建
- 检查案例的 `metadata.json` 中是否包含 `time_range.start` 和 `time_range.end`
- 确认时间格式是否正确
- 检查系统日志中的错误信息

#### 门架数据加载失败
- 确认数据库连接正常
- 检查数据库表 `dwd.dwd_flow_gantry_weekly` 是否存在且有数据
- 验证时间范围是否在数据库数据覆盖范围内（当前数据覆盖：2025年6月9日-7月6日）
- 检查数据库用户是否有访问 `dwd` schema 的权限
- 确认 `dwd.dwd_data_catalog` 表中有对应的分区信息

#### 精度分析失败
- 确认门架数据文件存在且格式正确
- 检查仿真数据是否包含可分析的列
- 查看分析日志中的详细错误信息

### 2. 调试方法

```python
# 启用详细日志
import logging
logging.basicConfig(level=logging.DEBUG)

# 检查门架数据文件夹
from pathlib import Path
case_path = Path("cases/case_20250819_100814")
gantry_folders = list(case_path.glob("gantry_*"))
print(f"找到的门架数据文件夹: {gantry_folders}")

# 检查门架数据内容
if gantry_folders:
    gantry_folder = gantry_folders[0]
    csv_file = gantry_folder / "gantry_data.csv"
    if csv_file.exists():
        import pandas as pd
        df = pd.read_csv(csv_file)
        print(f"门架数据形状: {df.shape}")
        print(f"列名: {df.columns.tolist()}")
```

## 更新日志

### v2.1.0 (2025-01-19)
- ✅ 修正与 data_in_db 文件夹中实际数据库表结构的冲突
- ✅ 更新文件命名：`gantry_data.csv` → `gantry_data_raw.csv`，`gantry_data_summary.json` → `gantry_summary.json`
- ✅ 添加完整的 `dwd.dwd_flow_gantry_weekly` 表结构说明
- ✅ 更新列名映射，基于实际数据库字段（start_gantryid, total, avg_speed等）
- ✅ 添加数据可用性检查功能说明
- ✅ 更新故障排除指南，包含具体的数据库表名和权限要求
- ✅ 添加数据时间范围说明（当前覆盖：2025年6月9日-7月6日）

### v2.0.0 (2025-01-19)
- ✅ 完成架构重构，门架数据管理完全模块化
- ✅ 统一使用 `shared.utilities.time_utils.parse_datetime` 进行时间解析
- ✅ 门架数据加载器迁移到 `shared/data_access/gantry_loader.py`
- ✅ 精度分析器迁移到 `shared/analysis_tools/accuracy_analyzer.py`
- ✅ 移除向后兼容性，采用全新模块化设计
- ✅ 优化文件夹命名规则，使用更直观的格式
- ✅ 完善错误处理和日志记录

---

*最后更新: 2025年1月19日*
