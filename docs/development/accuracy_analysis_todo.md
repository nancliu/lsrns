### 精度与机理-性能分析 TODO 清单（v1.1）

#### 阶段A（MVP，已具备/小改即得）

##### P0 仿真精度（accuracy）- 必做

- 指标与容错
  - [X] MAPE 分母为 0 的处理策略可配置（过滤/容忍/极小值），在结果 JSON 写明
  - [X] 公共列与长度对齐策略入参/出参记录（结果 JSON）
  - [X] E1 递归解析错误跳过并计数，损坏/不完整 XML 不中断
  - [X] 门架ID对齐：E1检测器前缀解析与 `dwd_flow_gantry_weekly.start_gantryid` 一致
- 图表与字体
  - [X] 统一中文字体（Microsoft YaHei/SimHei/Noto Sans CJK），无缺字告警
  - [X] 确认报告内图表相对路径 `../charts/*.png` 与 `/cases` 静态访问一致
  - [X] 完成直方图（观测vs仿真）、残差直方图(flow) 的导出与报告集成
- 报告与结构化结果
  - [X] analysis_results.json：补全 overall/gantry/time 层级统计、图表清单、数据源说明
  - [X] CSV 导出：总体、门架、时间、异常明细（若有）
  - [X] 报告概览卡片美化与阈值提示（MAPE≤15%、GEH≤5等）

##### P0 形成机理（mechanism）- 必做

- 仿真机理视图
  - [ ] 流-速散点图（sim：`flow` vs `speed`）
  - [ ] 速度时间序列图（sim：`speed`）
  - [ ] 流量残差随时间的峰值偏移概览（基于精度层合并后的残差时间序列）
- 图表集成
  - [ ] 在报告页面按主导航分组展示（精度/机理/性能）
  - [ ] 机理图表支持折叠/展开

##### P0 效率性能（performance）- 必做

- 数据与运行统计
  - [X] E1文件数与有效记录数统计
  - [X] 观测记录数统计（门架/收费站）
  - [X] 分析端到端耗时计算与展示
  - [X] 产物规模统计（图表数量、CSV与HTML大小）
  - [X] `summary.xml` 基础计数（loaded/inserted/running 等的总量或极值）
- 报告集成
  - [X] 效率统计表展示
  - [X] 处理耗时条/统计表

#### 阶段B（增强，需接入观测速度与收费站数据）

##### P1 仿真精度（accuracy）- 增强

- 速度精度对齐
  - [ ] 门架平均速度的 MAPE/相关性（观测速度 × 仿真速度对齐）
  - [ ] 实现 `load_observed_gantry_speed()` 方法，支持流量加权平均
  - [ ] 速度精度指标计算与展示
- 收费站流量对齐
  - [ ] 入口/出口流量对齐（前提：仿真侧存在相应E1或聚合输出）
  - [ ] 实现 `load_plaza_flows()` 方法
  - [ ] 收费站流量精度指标与图表

##### P1 标签化元数据

- API 返回增强
  - [ ] 在返回的 `metrics` 与 `chart_urls` 中附带图表/指标标签元数据
  - [ ] 标签字段：`{nav: 'accuracy'|'mechanism'|'performance', object: 'gantry'|'toll'|'od', scale: '5min'|'10min', source: 'sim_e1'|'obs_gantry', metric: 'flow'|'speed'}`

#### 阶段C（道路维度与多案例回归）

##### P1 道路/路线维度支持

- 映射表集成
  - [ ] 支持 `route_taz_matching` 表（TAZ 对应门架/收费广场 ID）
  - [ ] 实现道路级精度汇总与机理分面
  - [ ] 按 `route_id` 展示不同道路的流-速分布差异
  - [ ] 道路级精度汇总条形图/表格
- 回退策略
  - [ ] 优先 `route_taz_matching` → 其次 `route_mapping.csv` → 再退全网级/门架级

##### P2 多案例对比与回归

- OD窗口校验
  - [ ] OD起止窗口校验（仿真投放时段与观测窗口的一致性校验与提示）
- 多案例回归
  - [ ] 多案例对比与回归报告（基线 vs 当前）

#### P1 可选增强

- 图表
  - [ ] 残差–观测散点（密度着色）
  - [ ] 门架/时段箱线图；门架×时间热力图
  - [ ] 按道路分面的流-速散点
- 指标
  - [ ] 加权指标（按流量权重）
  - [ ] 峰值小时流量对比与时移检测
- 前端
  - [X] 报告页"查看报告"按钮可用；前端新增 CSV 下载列表
  - [X] 结果卡片展示概览
  - [ ] 标签化筛选器（主导航、对象、尺度、数据源、指标类型）

#### P2 研发支持

- 单元测试
  - [ ] E1解析、指标函数、路径生成、空/异常数据
  - [ ] 新增观测数据加载方法测试
- 集成测试
  - [ ] 端到端案例（小/大样本），出图/出报校验
  - [ ] 道路维度汇总测试
- 性能压测
  - [ ] E1大量文件解析耗时与内存开销评估
  - [ ] 观测数据查询性能评估
- 文档
  - [ ] 开发指南（数据格式、扩展点、指标定义）
  - [ ] 道路映射表设计说明

#### 验收标准

##### 阶段A（MVP）

- [X] 任意案例生成报告成功，无未捕获异常
- [X] 报告页面全部图片正常显示，无中文缺字
- [X] API 返回 `report_url`/`chart_urls`/`csv_urls`，前端"查看报告"与CSV下载可用
- [X] 指标抽样与手工校核一致
- [X] CSV/JSON 字段稳定、可自描述
- [X] 主导航（精度/机理/性能）分组展示正常

##### 新增（阶段A 完成项）

- [X] 历史精度结果回看 API：`GET /api/v1/accuracy_results/{case_id}`
- [X] 前端“查看历史结果”按钮与列表渲染

##### 阶段B（增强）

- [ ] 速度精度指标计算正确
- [ ] 收费站流量对齐功能正常
- [ ] API 返回包含标签元数据

##### 阶段C（道路维度）

- [ ] 道路级汇总与分面展示正常
- [ ] 映射表回退策略工作正常
- [ ] 多案例对比功能可用
