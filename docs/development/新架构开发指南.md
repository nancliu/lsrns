# æ–°æ¶æ„å¼€å‘æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—é¢å‘å¼€å‘å›¢é˜Ÿï¼Œä»‹ç»å¦‚ä½•åœ¨é‡æ„å®Œæˆåçš„æ¨¡å—åŒ–æ¶æ„ä¸‹è¿›è¡Œå¼€å‘ã€‚æ–°æ¶æ„é‡‡ç”¨é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ŒæŒ‰ä¸šåŠ¡åŠŸèƒ½ç»„ç»‡ä»£ç ï¼Œæä¾›æ›´å¥½çš„å¼€å‘ä½“éªŒå’Œä»£ç ç»´æŠ¤æ€§ã€‚

**å½“å‰ç‰ˆæœ¬**: v0.65 - åˆ†æåŠŸèƒ½å®Œå–„ï¼Œæ ¸å¿ƒåŠŸèƒ½å®Œå…¨å¯ç”¨

## ğŸ—ï¸ æ¶æ„åŸåˆ™

### 1. é¢†åŸŸé©±åŠ¨è®¾è®¡ (DDD)
- æŒ‰ä¸šåŠ¡é¢†åŸŸç»„ç»‡ä»£ç æ¨¡å—
- æ¯ä¸ªæ¨¡å—æœ‰æ˜ç¡®çš„ä¸šåŠ¡è¾¹ç•Œ
- é¿å…è·¨é¢†åŸŸçš„å¼ºè€¦åˆ

### 2. åˆ†å±‚æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Routes Layer  â”‚  â† APIç«¯ç‚¹ï¼Œè¯·æ±‚å“åº”å¤„ç†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Services Layer â”‚  â† ä¸šåŠ¡é€»è¾‘ï¼Œæ ¸å¿ƒåŠŸèƒ½å®ç°
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Models Layer  â”‚  â† æ•°æ®æ¨¡å‹ï¼Œç±»å‹å®šä¹‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Shared Layer  â”‚  â† æ ¸å¿ƒç®—æ³•ã€å·¥å…·å‡½æ•°ã€æ•°æ®è®¿é—®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. ä¾èµ–æ–¹å‘
- ä¸Šå±‚ä¾èµ–ä¸‹å±‚ï¼Œä¸‹å±‚ä¸ä¾èµ–ä¸Šå±‚
- Routes â†’ Services â†’ Models
- Services â†’ Shared (utilities, data_access, analysis_tools)
- é¿å…å¾ªç¯ä¾èµ–

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒè®¾ç½®

### 1. é¡¹ç›®ç»“æ„ç†è§£

```
api/                    # APIå±‚ - ä¸“æ³¨äºæ¥å£å’Œä¸šåŠ¡åè°ƒ
â”œâ”€â”€ main.py            # å”¯ä¸€å…¥å£ç‚¹
â”œâ”€â”€ __init__.py        # åŒ…åˆå§‹åŒ–
â”œâ”€â”€ services/          # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ __init__.py    # å¯¹å¤–ç»Ÿä¸€æ¥å£
â”‚   â”œâ”€â”€ base_service.py  # åŸºç¡€æœåŠ¡ç±»
â”‚   â””â”€â”€ *_service.py   # å…·ä½“ä¸šåŠ¡æœåŠ¡
â”œâ”€â”€ models/            # æ•°æ®æ¨¡å‹å±‚
â”‚   â”œâ”€â”€ __init__.py    # å¯¹å¤–ç»Ÿä¸€æ¥å£
â”‚   â”œâ”€â”€ enums.py       # æšä¸¾å®šä¹‰
â”‚   â”œâ”€â”€ base.py        # åŸºç¡€æ¨¡å‹
â”‚   â”œâ”€â”€ requests/      # è¯·æ±‚æ¨¡å‹
â”‚   â”œâ”€â”€ responses/     # å“åº”æ¨¡å‹
â”‚   â””â”€â”€ entities/      # å®ä½“æ¨¡å‹
â””â”€â”€ routes/            # APIè·¯ç”±å±‚
    â”œâ”€â”€ __init__.py    # è·¯ç”±ç»„ç»‡
    â”œâ”€â”€ middleware.py  # å…¬å…±ä¸­é—´ä»¶
    â””â”€â”€ *_routes.py    # åˆ†ç»„è·¯ç”±

shared/                # å…±äº«æ ¸å¿ƒåŠŸèƒ½å±‚
â”œâ”€â”€ utilities/         # é€šç”¨å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ __init__.py    # å·¥å…·å‡½æ•°ç»Ÿä¸€æ¥å£
â”‚   â””â”€â”€ *_utils.py     # åˆ†ç±»å·¥å…·å‡½æ•°
â”œâ”€â”€ data_access/       # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ __init__.py    # ç»Ÿä¸€å¯¼å‡º
â”‚   â””â”€â”€ *.py           # æ•°æ®è®¿é—®ç›¸å…³åŠŸèƒ½
â””â”€â”€ analysis_tools/    # åˆ†æå·¥å…·
    â”œâ”€â”€ __init__.py    # ç»Ÿä¸€å¯¼å‡º
    â””â”€â”€ *.py           # åˆ†æç›¸å…³åŠŸèƒ½
```

### 2. IDEé…ç½®

#### VS Code é…ç½®ç¤ºä¾‹

```json
// .vscode/settings.json
{
    "python.analysis.extraPaths": ["./"],
    "python.linting.enabled": true,
    "python.linting.pylintEnabled": true,
    "python.formatting.provider": "black",
    "python.formatting.blackArgs": ["--line-length", "100"],
    "files.exclude": {
        "**/__pycache__": true,
        "**/*.pyc": true
    }
}
```

#### PyCharm é…ç½®
- è®¾ç½®é¡¹ç›®æ ¹ç›®å½•ä¸ºæºç æ ¹ç›®å½•
- é…ç½®ä»£ç é£æ ¼ä¸º Black
- å¯ç”¨ç±»å‹æ£€æŸ¥

## ğŸ‘¨â€ğŸ’» å¼€å‘å·¥ä½œæµ

### 1. æ–°åŠŸèƒ½å¼€å‘æµç¨‹

#### æ­¥éª¤1: ç¡®å®šåŠŸèƒ½å½’å±
```python
# é—®é¢˜ï¼šæˆ‘è¦æ·»åŠ ä¸€ä¸ªæ–°çš„æ•°æ®å¯¼å‡ºåŠŸèƒ½ï¼Œåº”è¯¥æ”¾åœ¨å“ªé‡Œï¼Ÿ

# åˆ†æï¼š
# - è¿™æ˜¯æ•°æ®å¤„ç†ç›¸å…³åŠŸèƒ½ â†’ api/services/data_service.py
# - éœ€è¦æ–°çš„è¯·æ±‚æ¨¡å‹ â†’ api/models/requests/data_requests.py  
# - éœ€è¦æ–°çš„APIç«¯ç‚¹ â†’ api/routes/data_routes.py
# - å¯èƒ½éœ€è¦æ–‡ä»¶æ“ä½œå·¥å…· â†’ shared/utilities/file_utils.py
```

#### æ­¥éª¤2: æ¨¡å‹å®šä¹‰
```python
# api/models/requests/data_requests.py
class DataExportRequest(BaseModel):
    case_id: str
    export_format: str = "csv"
    include_metadata: bool = True
    
    class Config:
        schema_extra = {
            "example": {
                "case_id": "case_20250119_143000",
                "export_format": "csv",
                "include_metadata": True
            }
        }
```

#### æ­¥éª¤3: æœåŠ¡å®ç°
```python
# api/services/data_service.py
class DataService(BaseService):
    async def export_data(self, request: DataExportRequest) -> Dict[str, Any]:
        """å¯¼å‡ºæ¡ˆä¾‹æ•°æ®"""
        try:
            # 1. éªŒè¯æ¡ˆä¾‹å­˜åœ¨
            case_path = self._get_case_path(request.case_id)
            if not case_path.exists():
                raise ValueError(f"æ¡ˆä¾‹ä¸å­˜åœ¨: {request.case_id}")
            
            # 2. è°ƒç”¨å…±äº«å·¥å…·è¿›è¡Œå¯¼å‡º
            from shared.utilities.file_utils import export_case_data
            result = export_case_data(case_path, request.export_format)
            
            # 3. æ›´æ–°å…ƒæ•°æ®
            self._update_export_history(request.case_id, result)
            
            return result
            
        except Exception as e:
            logger.error(f"æ•°æ®å¯¼å‡ºå¤±è´¥: {e}")
            raise
```

#### æ­¥éª¤4: è·¯ç”±æ³¨å†Œ
```python
# api/routes/data_routes.py
@router.post("/export_data/", response_model=BaseResponse)
async def export_data(request: DataExportRequest):
    """å¯¼å‡ºæ¡ˆä¾‹æ•°æ®"""
    try:
        data_service = DataService()
        result = await data_service.export_data(request)
        return create_success_response("æ•°æ®å¯¼å‡ºæˆåŠŸ", result)
    except Exception as e:
        return create_error_response(f"æ•°æ®å¯¼å‡ºå¤±è´¥: {str(e)}")
```

### 2. ä»£ç ç»„ç»‡åŸåˆ™

#### å•ä¸€èŒè´£åŸåˆ™
```python
# âœ… å¥½çš„åšæ³•ï¼šæ¯ä¸ªç±»/å‡½æ•°åªè´Ÿè´£ä¸€ä»¶äº‹
class CaseService(BaseService):
    def create_case(self, request: CreateCaseRequest) -> Case:
        """åˆ›å»ºæ¡ˆä¾‹"""
        pass
    
    def get_case(self, case_id: str) -> Case:
        """è·å–æ¡ˆä¾‹"""
        pass

# âŒ é¿å…ï¼šä¸€ä¸ªç±»åšå¤ªå¤šäº‹æƒ…
class CaseManager:
    def create_case(self): pass
    def get_case(self): pass
    def run_simulation(self): pass  # è¿™åº”è¯¥å±äºSimulationService
    def analyze_results(self): pass  # è¿™åº”è¯¥å±äºAnalysisService
```

#### ä¾èµ–æ³¨å…¥
```python
# âœ… å¥½çš„åšæ³•ï¼šé€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–
class AnalysisService(BaseService):
    def __init__(self, gantry_loader: GantryDataLoader = None):
        super().__init__()
        self.gantry_loader = gantry_loader or GantryDataLoader()
    
    async def analyze_accuracy(self, case_id: str) -> Dict[str, Any]:
        # ä½¿ç”¨æ³¨å…¥çš„ä¾èµ–
        gantry_data = await self.gantry_loader.load_gantry_data(case_id)
        # ... åˆ†æé€»è¾‘
```

### 3. é”™è¯¯å¤„ç†

#### ç»Ÿä¸€å¼‚å¸¸å¤„ç†
```python
# api/routes/middleware.py
@handle_service_errors
async def api_endpoint(request):
    """ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†è£…é¥°å™¨"""
    try:
        result = await service_function(request)
        return create_success_response("æ“ä½œæˆåŠŸ", result)
    except ValidationError as e:
        return create_error_response(f"å‚æ•°éªŒè¯å¤±è´¥: {str(e)}", status_code=400)
    except ValueError as e:
        return create_error_response(f"ä¸šåŠ¡é€»è¾‘é”™è¯¯: {str(e)}", status_code=400)
    except Exception as e:
        logger.error(f"æœªé¢„æœŸçš„é”™è¯¯: {e}")
        return create_error_response("æœåŠ¡å™¨å†…éƒ¨é”™è¯¯", status_code=500)
```

#### ä¸šåŠ¡å¼‚å¸¸å®šä¹‰
```python
# api/models/exceptions.py
class CaseNotFoundError(ValueError):
    """æ¡ˆä¾‹ä¸å­˜åœ¨å¼‚å¸¸"""
    pass

class SimulationRunningError(RuntimeError):
    """ä»¿çœŸæ­£åœ¨è¿è¡Œå¼‚å¸¸"""
    pass

class InvalidAnalysisDataError(ValueError):
    """åˆ†ææ•°æ®æ— æ•ˆå¼‚å¸¸"""
    pass
```

## ğŸ”§ æ ¸å¿ƒå¼€å‘æ¨¡å¼

### 1. åŸºç¡€æœåŠ¡æ¨¡å¼

```python
# api/services/base_service.py
class BaseService(ABC):
    """åŸºç¡€æœåŠ¡ç±»ï¼Œæä¾›å…¬å…±åŠŸèƒ½"""
    
    def __init__(self):
        self.logger = logging.getLogger(self.__class__.__name__)
    
    def load_metadata(self, file_path: Path) -> Dict[str, Any]:
        """åŠ è½½å…ƒæ•°æ®æ–‡ä»¶"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                return json.load(f)
        except Exception as e:
            self.logger.error(f"åŠ è½½å…ƒæ•°æ®å¤±è´¥ {file_path}: {e}")
            return {}
    
    def save_metadata(self, file_path: Path, metadata: Dict[str, Any]):
        """ä¿å­˜å…ƒæ•°æ®æ–‡ä»¶"""
        try:
            file_path.parent.mkdir(parents=True, exist_ok=True)
            with open(file_path, 'w', encoding='utf-8') as f:
                json.dump(metadata, f, ensure_ascii=False, indent=2)
        except Exception as e:
            self.logger.error(f"ä¿å­˜å…ƒæ•°æ®å¤±è´¥ {file_path}: {e}")
            raise
    
    def generate_unique_id(self, prefix: str = "item") -> str:
        """ç”Ÿæˆå”¯ä¸€ID"""
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        random_suffix = ''.join(random.choices(string.ascii_lowercase + string.digits, k=6))
        return f"{prefix}_{timestamp}_{random_suffix}"
```

### 2. å…ƒæ•°æ®ç®¡ç†æ¨¡å¼

```python
# api/services/base_service.py
class MetadataManager:
    """å…ƒæ•°æ®ç®¡ç†å™¨ï¼Œæä¾›å…ƒæ•°æ®æ“ä½œåŠŸèƒ½"""
    
    @staticmethod
    def load_case_metadata(case_path: Path) -> Dict[str, Any]:
        """åŠ è½½æ¡ˆä¾‹å…ƒæ•°æ®"""
        metadata_file = case_path / "metadata.json"
        if metadata_file.exists():
            try:
                with open(metadata_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except Exception as e:
                logger.error(f"åŠ è½½æ¡ˆä¾‹å…ƒæ•°æ®å¤±è´¥ {metadata_file}: {e}")
        return {}
    
    @staticmethod
    def update_simulations_index(case_path: Path, simulation_id: str, sim_metadata: dict):
        """æ›´æ–°ä»¿çœŸç´¢å¼•"""
        metadata_file = case_path / "metadata.json"
        metadata = MetadataManager.load_case_metadata(case_path)
        
        if "simulations" not in metadata:
            metadata["simulations"] = {}
        
        metadata["simulations"][simulation_id] = sim_metadata
        metadata["last_updated"] = datetime.now().isoformat()
        
        try:
            with open(metadata_file, 'w', encoding='utf-8') as f:
                json.dump(metadata, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.error(f"æ›´æ–°ä»¿çœŸç´¢å¼•å¤±è´¥ {metadata_file}: {e}")
            raise
```

### 3. ç›®å½•ç®¡ç†æ¨¡å¼

```python
# api/services/base_service.py
class DirectoryManager:
    """ç›®å½•ç®¡ç†å™¨ï¼Œæä¾›ç›®å½•ç»“æ„ç®¡ç†åŠŸèƒ½"""
    
    @staticmethod
    def create_case_structure(case_path: Path, case_name: str) -> Dict[str, Path]:
        """åˆ›å»ºæ¡ˆä¾‹ç›®å½•ç»“æ„"""
        directories = {
            "config": case_path / "config",
            "simulations": case_path / "simulations",
            "analysis": case_path / "analysis",
            "outputs": case_path / "outputs",
            "logs": case_path / "logs"
        }
        
        for dir_path in directories.values():
            dir_path.mkdir(parents=True, exist_ok=True)
        
        return directories
    
    @staticmethod
    def create_simulation_structure(sim_path: Path, sim_type: str) -> Dict[str, Path]:
        """åˆ›å»ºä»¿çœŸç›®å½•ç»“æ„"""
        directories = {
            "config": sim_path / "config",
            "outputs": sim_path / "outputs",
            "logs": sim_path / "logs"
        }
        
        # æ ¹æ®ä»¿çœŸç±»å‹åˆ›å»ºç‰¹å®šç›®å½•
        if sim_type == "microscopic":
            directories["e1_detectors"] = sim_path / "e1_detectors"
        elif sim_type == "mesoscopic":
            directories["summary"] = sim_path / "summary"
        
        for dir_path in directories.values():
            dir_path.mkdir(parents=True, exist_ok=True)
        
        return directories
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•

```python
# tests/test_data_service.py
import pytest
from unittest.mock import Mock, patch
from api.services.data_service import DataService
from api.models.requests.data_requests import TimeRangeRequest

class TestDataService:
    def setup_method(self):
        self.service = DataService()
    
    def test_process_od_data_success(self):
        """æµ‹è¯•ODæ•°æ®å¤„ç†æˆåŠŸåœºæ™¯"""
        request = TimeRangeRequest(
            start_time="2025/07/21 08:00:00",
            end_time="2025/07/21 09:00:00",
            case_name="æµ‹è¯•æ¡ˆä¾‹"
        )
        
        with patch('shared.data_access.od_table_resolver.get_table_names_from_date') as mock_resolver:
            mock_resolver.return_value = ["dwd_20250721"]
            
            result = self.service.process_od_data(request)
            
            assert result["success"] is True
            assert "case_id" in result["data"]
            assert result["data"]["status"] == "completed"
    
    def test_process_od_data_invalid_time_range(self):
        """æµ‹è¯•æ— æ•ˆæ—¶é—´èŒƒå›´åœºæ™¯"""
        request = TimeRangeRequest(
            start_time="2025/07/21 09:00:00",
            end_time="2025/07/21 08:00:00",  # ç»“æŸæ—¶é—´æ—©äºå¼€å§‹æ—¶é—´
            case_name="æµ‹è¯•æ¡ˆä¾‹"
        )
        
        with pytest.raises(ValueError, match="ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´"):
            self.service.process_od_data(request)
```

### 2. é›†æˆæµ‹è¯•

```python
# tests/test_integration.py
import pytest
from fastapi.testclient import TestClient
from api.main import app

client = TestClient(app)

class TestIntegration:
    def test_full_workflow(self):
        """æµ‹è¯•å®Œæ•´å·¥ä½œæµç¨‹"""
        # 1. åˆ›å»ºæ¡ˆä¾‹
        case_response = client.post("/api/v1/case/create_case/", json={
            "case_name": "é›†æˆæµ‹è¯•æ¡ˆä¾‹",
            "description": "æµ‹è¯•å®Œæ•´å·¥ä½œæµç¨‹"
        })
        assert case_response.status_code == 200
        case_id = case_response.json()["data"]["case_id"]
        
        # 2. å¤„ç†ODæ•°æ®
        od_response = client.post("/api/v1/data/process_od_data/", json={
            "start_time": "2025/07/21 08:00:00",
            "end_time": "2025/07/21 09:00:00",
            "case_name": "é›†æˆæµ‹è¯•æ¡ˆä¾‹"
        })
        assert od_response.status_code == 200
        
        # 3. è¿è¡Œä»¿çœŸ
        sim_response = client.post("/api/v1/simulation/run_simulation/", json={
            "case_id": case_id,
            "simulation_type": "microscopic"
        })
        assert sim_response.status_code == 200
        
        # 4. æ£€æŸ¥ç»“æœ
        case_detail = client.get(f"/api/v1/case/case_detail/{case_id}")
        assert case_detail.status_code == 200
        assert case_detail.json()["data"]["status"] == "completed"
```

## ğŸ“š æœ€ä½³å®è·µ

### 1. ä»£ç é£æ ¼

#### å‘½åè§„èŒƒ
```python
# âœ… å¥½çš„å‘½å
class DataService:           # ç±»åä½¿ç”¨PascalCase
    def process_od_data():   # æ–¹æ³•åä½¿ç”¨snake_case
        pass

# å˜é‡å‘½å
case_id = "case_20250119_143000"    # ä½¿ç”¨ä¸‹åˆ’çº¿åˆ†éš”
simulation_type = "microscopic"     # æè¿°æ€§å‘½å

# âŒ é¿å…çš„å‘½å
class dataservice:           # ç±»ååº”è¯¥å¤§å†™
    def ProcessODData():     # æ–¹æ³•ååº”è¯¥å°å†™
        pass

# å˜é‡å‘½å
c = "case_20250119_143000"  # å•å­—æ¯å˜é‡å
st = "microscopic"          # ç¼©å†™ä¸æ¸…æ™°
```

#### æ–‡æ¡£å­—ç¬¦ä¸²
```python
def process_od_data(
    start_time: str,
    end_time: str,
    case_name: str,
    **kwargs
) -> Dict[str, Any]:
    """
    å¤„ç†ODæ•°æ®å¹¶åˆ›å»ºæ¡ˆä¾‹
    
    Args:
        start_time: å¼€å§‹æ—¶é—´ï¼Œæ ¼å¼ï¼šYYYY/MM/DD HH:MM:SS
        end_time: ç»“æŸæ—¶é—´ï¼Œæ ¼å¼ï¼šYYYY/MM/DD HH:MM:SS
        case_name: æ¡ˆä¾‹åç§°
        **kwargs: å…¶ä»–å‚æ•°
        
    Returns:
        åŒ…å«å¤„ç†ç»“æœçš„å­—å…¸
        
    Raises:
        ValueError: æ—¶é—´æ ¼å¼æ— æ•ˆæˆ–æ—¶é—´èŒƒå›´é”™è¯¯
        RuntimeError: æ•°æ®å¤„ç†å¤±è´¥
        
    Example:
        >>> result = process_od_data(
        ...     start_time="2025/07/21 08:00:00",
        ...     end_time="2025/07/21 09:00:00",
        ...     case_name="æµ‹è¯•æ¡ˆä¾‹"
        ... )
        >>> print(result["case_id"])
        case_20250119_143000
    """
    pass
```

### 2. æ€§èƒ½ä¼˜åŒ–

#### å¼‚æ­¥å¤„ç†
```python
# âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨å¼‚æ­¥å¤„ç†
async def process_multiple_cases(case_ids: List[str]) -> List[Dict[str, Any]]:
    """å¹¶å‘å¤„ç†å¤šä¸ªæ¡ˆä¾‹"""
    tasks = [process_single_case(case_id) for case_id in case_ids]
    results = await asyncio.gather(*tasks, return_exceptions=True)
    return results

# âŒ é¿å…ï¼šåŒæ­¥å¤„ç†
def process_multiple_cases_sync(case_ids: List[str]) -> List[Dict[str, Any]]:
    """åŒæ­¥å¤„ç†å¤šä¸ªæ¡ˆä¾‹ï¼ˆæ€§èƒ½è¾ƒå·®ï¼‰"""
    results = []
    for case_id in case_ids:
        result = process_single_case_sync(case_id)
        results.append(result)
    return results
```

#### ç¼“å­˜æœºåˆ¶
```python
from functools import lru_cache

class DataService(BaseService):
    @lru_cache(maxsize=128)
    def get_table_names_from_date(self, date_str: str) -> List[str]:
        """ç¼“å­˜è¡¨åæŸ¥è¯¢ç»“æœ"""
        return get_table_names_from_date(date_str)
```

### 3. é”™è¯¯å¤„ç†

#### ä¼˜é›…é™çº§
```python
async def analyze_accuracy(self, case_id: str) -> Dict[str, Any]:
    """åˆ†æç²¾åº¦ï¼Œæ”¯æŒä¼˜é›…é™çº§"""
    try:
        # å°è¯•å®Œæ•´åˆ†æ
        return await self._full_accuracy_analysis(case_id)
    except Exception as e:
        logger.warning(f"å®Œæ•´åˆ†æå¤±è´¥ï¼Œå°è¯•åŸºç¡€åˆ†æ: {e}")
        
        try:
            # é™çº§åˆ°åŸºç¡€åˆ†æ
            return await self._basic_accuracy_analysis(case_id)
        except Exception as e2:
            logger.error(f"åŸºç¡€åˆ†æä¹Ÿå¤±è´¥: {e2}")
            # è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œä½†ä¸ä¸­æ–­ç¨‹åº
            return {
                "success": False,
                "error": f"åˆ†æå¤±è´¥: {str(e2)}",
                "fallback_available": False
            }
```

## ğŸš€ éƒ¨ç½²å’Œè¿ç»´

### 1. ç¯å¢ƒé…ç½®

```python
# shared/utilities/config_utils.py
import os
from typing import Optional

def get_env_config(key: str, default: Optional[str] = None) -> str:
    """è·å–ç¯å¢ƒé…ç½®"""
    value = os.getenv(key, default)
    if value is None:
        raise ValueError(f"å¿…éœ€çš„ç¯å¢ƒå˜é‡æœªè®¾ç½®: {key}")
    return value

# é…ç½®ç¤ºä¾‹
DATABASE_URL = get_env_config("DATABASE_URL")
API_HOST = get_env_config("API_HOST", "0.0.0.0")
API_PORT = int(get_env_config("API_PORT", "8000"))
DEBUG = get_env_config("DEBUG", "false").lower() == "true"
```

### 2. æ—¥å¿—é…ç½®

```python
# shared/utilities/logging_utils.py
import logging
import sys
from pathlib import Path

def setup_logging(
    log_level: str = "INFO",
    log_file: Optional[Path] = None,
    log_format: str = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
):
    """è®¾ç½®æ—¥å¿—é…ç½®"""
    # è®¾ç½®æ ¹æ—¥å¿—çº§åˆ«
    logging.basicConfig(
        level=getattr(logging, log_level.upper()),
        format=log_format,
        handlers=[
            logging.StreamHandler(sys.stdout)
        ]
    )
    
    # å¦‚æœæŒ‡å®šäº†æ—¥å¿—æ–‡ä»¶ï¼Œæ·»åŠ æ–‡ä»¶å¤„ç†å™¨
    if log_file:
        file_handler = logging.FileHandler(log_file)
        file_handler.setFormatter(logging.Formatter(log_format))
        logging.getLogger().addHandler(file_handler)
    
    # è®¾ç½®ç¬¬ä¸‰æ–¹åº“çš„æ—¥å¿—çº§åˆ«
    logging.getLogger("uvicorn").setLevel(logging.INFO)
    logging.getLogger("fastapi").setLevel(logging.INFO)
```

## ğŸ“š ç›¸å…³èµ„æº

### 1. å®˜æ–¹æ–‡æ¡£
- [FastAPIå®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [Pydanticå®˜æ–¹æ–‡æ¡£](https://pydantic-docs.helpmanual.io/)
- [Pythonå¼‚æ­¥ç¼–ç¨‹](https://docs.python.org/3/library/asyncio.html)

### 2. é¡¹ç›®æ–‡æ¡£
- [æ¶æ„é‡æ„å®ŒæˆæŠ¥å‘Š](æ¶æ„é‡æ„å®ŒæˆæŠ¥å‘Š.md)
- [æ–°æ¶æ„APIæŒ‡å—](../api_docs/æ–°æ¶æ„APIæŒ‡å—.md)
- [é—¨æ¶æ•°æ®ç®¡ç†è¯´æ˜](é—¨æ¶æ•°æ®ç®¡ç†è¯´æ˜.md)

### 3. å¼€å‘å·¥å…·
- [Blackä»£ç æ ¼å¼åŒ–](https://black.readthedocs.io/)
- [Pylintä»£ç æ£€æŸ¥](https://www.pylint.org/)
- [Pytestæµ‹è¯•æ¡†æ¶](https://docs.pytest.org/)

## ğŸ”„ æ›´æ–°æ—¥å¿—

### v2.0.0 (2025-01-19)
- âœ… å®Œæˆæ¶æ„é‡æ„
- âœ… å®ç°å®Œå…¨æ¨¡å—åŒ–è®¾è®¡
- âœ… ç§»é™¤å‘åå…¼å®¹æ€§
- âœ… ä¼˜åŒ–å¼€å‘ä½“éªŒ
- âœ… å®Œå–„æµ‹è¯•ç­–ç•¥
- âœ… æ›´æ–°å¼€å‘æŒ‡å—

---

*æœ€åæ›´æ–°: 2025å¹´1æœˆ19æ—¥*
